generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_DATABASE_URL")
}

model User {
  id             String              @id @default(uuid())
  email          String              @unique
  passwordHash   String
  createdAt      DateTime            @default(now())
  progress       UserWordProgress[]
  quizAttempts   QuizAttempt[]
}

model VocabularyWord {
  id             String               @id @default(uuid())
  word           String
  meaning        String
  example        String?
  pronunciation  String?
  type           String?
  transcription  String?
  imageUrl       String?
  audioUrl       String?
  synonyms       String[]
  antonyms       String[]
  level          String?             
  createdAt      DateTime            @default(now())

  topics         WordTopic[]
  userProgress   UserWordProgress[]
}

model Topic {
  id                  String         @id @default(uuid())
  slug                String?        @unique 
  name                String         @unique
  level               String?      
  description         String?      
  paragraph           String?      
  englishTranslation  String?   
  difficulty          String?      
  estimatedTime       String?     
  createdAt           DateTime       @default(now())

  words               WordTopic[]  
  quizQuestions       QuizQuestion[]

  @@index([level])
  @@index([slug]) 
}

model WordTopic {
  id        String   @id @default(uuid())
  wordId    String?
  topicId   String?

  word      VocabularyWord? @relation(fields: [wordId], references: [id], onDelete: Cascade)
  topic     Topic?          @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([wordId, topicId])
}

model UserWordProgress {
  id             String   @id @default(uuid())
  userId         String
  wordId         String

  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  word           VocabularyWord    @relation(fields: [wordId], references: [id], onDelete: Cascade)

  nextReviewAt   DateTime          
  correctCount   Int      @default(0)
  incorrectCount Int      @default(0)
  lastReviewedAt DateTime @default(now())
  lastCorrect    Boolean  @default(false)  
  isMastered     Boolean  @default(false) 
  masteryLevel   Int      @default(0)     
  streak         Int      @default(0)     

  @@index([userId])
  @@index([wordId])
  @@index([nextReviewAt])
  @@unique([userId, wordId])
}

model QuizQuestion {
  id        String   @id @default(uuid())
  topicId   String
  text      String
  type      String      
  level     String?
  createdAt DateTime @default(now())

  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  choices   QuizChoice[]
  attempts  QuizAttempt[]
}

model QuizChoice {
  id         String   @id @default(uuid())
  questionId String
  index      Int
  text       String
  isCorrect  Boolean  @default(false)

  question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([questionId, index])
}

model QuizAttempt {
  id            String   @id @default(uuid())
  userId        String
  questionId    String
  selectedIndex Int
  isCorrect     Boolean
  answeredAt    DateTime @default(now())

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  question      QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([questionId])
  @@unique([userId, questionId])
}
